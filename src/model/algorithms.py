import commands
import numpy as np
import csv
import os
import sys

import modelUtils
from scipy.stats import chi2_contingency
from itertools import izip 

class FeatureSelector:
	'''
	The feature file is either horizonal or vertical.
	Horizonal means one row represent one feature.
	Vertcal means one column represent one feature.
	'''
	def __init__(self, featurelist, featurefile, indexing='v'):
		csv.field_size_limit(sys.maxsize)
		self.flist = csv.reader(open(featurelist, 'r'))
		'''
		# This is too slow
		modelUtils.transposeLargeFile(featurefile, 'T' + featurefile)
		featurefile = 'T' + featurefile
		'''
		self.data = modelUtils.SparseMatrix(featurefile, fmt=indexing)

	def myChisquare(self, values):
		# Uses chisquare
		print values
		values = [pair for pair in values if not np.all(np.array(pair) == 0)]
		chi2, p, dof, ex = chi2_contingency(values)
		print chi2, p, dof
		return chi2, p

	def binHist(self, btotal, mtotal, values, threshold=0):
		# Uses chisquare
		# chisquare(values)
		# Implement chisquare
		# A = malicious contexts with feature
		# B = benign contexts with feature
		# C = malicious contexts without feature
		# D = benign contexts without feature
		if not threshold == 0:
			values = self.data.normalizeRow(values)
		A = (values[btotal:] > threshold).sum()
		B = (values[:btotal] > threshold).sum()
		# A = int(np.sum([1 for item in values[btotal:] if item > threshold]))
		# B = np.sum([1 for item in values[:btotal] if item > threshold])
		C = mtotal - A
		D = btotal - B
		return self.myChisquare([[A, B], [C,D]])
		# print 'A:{0}, B:{1}, C:{2}, D:{3}'.format(A,B,C,D)
		# return (A*D - C*B)*(A*D - C*B) / ( (A+C)* (B+D) * (A+B) * (C+D) )

	def scaleHist(self, btotal, mtotal, values, binnum = 10):
		values = self.data.logCeilRow(values)
		benign = values[:btotal]
		malicious = values[btotal:]
		benign_hist = self.data.histogramRow(benign, binnum)
		malicious_hist = self.data.histogramRow(malicious, binnum)
		return self.myChisquare(np.column_stack((benign_hist, malicious_hist)))

	def selectFeatures(self, outlist, outfile, blacklist, method='binHist', thresbin = 0, pthreshold=0.05):
		writer = csv.writer(open(outfile, 'w'))
		outlist = csv.writer(open(outlist, 'w'))
		blacklist = csv.writer(open(blacklist, 'w'))
		first = True
		for row in self.data.matrix:
			if first:
				# The first row is label
				first = False
				continue
			feature = self.flist.next()
			row = self.data.formatRow(row)
			if thresbin == 0:
				chi2, p = getattr(self, method)(self.data.btotal, self.data.mtotal, row)
			else:
				chi2, p = getattr(self, method)(self.data.btotal, self.data.mtotal, row, thresbin)

			if p < pthreshold:
				writer.writerow(row)
				outlist.writerow(feature)
			else:
				blacklist.writerow(feature)


if __name__=="__main__":
	# dt = DecisionTreeModel()
	# dt.crossValidation()
	'''
	fs = FeatureSelector('/space/outputlogs112/backup/Flat-Level-Features-In-CSV-Order.log', \
		'/space/outputlogs112/backup/BinarizeFeature0.csv')
	fs.binarizedFeature('/space/outputlogs112/backup/featurelist0.log', \
		'/space/outputlogs112/backup/features0.csv', threshold=1.64) # 0.8
	'''
	hold = 0
	thres = 0.001

	fs = FeatureSelector('/data/urlcrawl/outputlogs112/Flat-Level.log', '/data/urlcrawl/outputlogs112/Flat-Level-Count.csv')
	fs.selectFeatures('/data/urlcrawl/outputlogs112/featurelist{0}.log'.format(hold), '/data/urlcrawl/outputlogs112/features{0}.csv'.format(hold), '/data/urlcrawl/outputlogs112/blacklist{0}.csv'.format(hold), method='binHist', thresbin=hold, pthreshold=thres)

	'''
	fs = FeatureSelector('test.log', 'test.csv')
	fs.selectFeatures('templist{0}.log'.format(hold), 'tempdata{0}.csv'.format(hold), 'blacklist{0}.csv'.format(hold), method='scaleHist', thresbin=hold, pthreshold=thres)
	'''

	# modelUtils.processFile(threshold = hold)
	'''
	fs = FeatureSelector('/space/outputlogs112/Flat-Level.log', '/space/outputlogs112/Flat-Level-Count.csv')
	fs.selectFeatures('/space/outputlogs112/featurelist{0}.log'.format(hold), '/space/outputlogs112/features{0}.csv'.format(hold), '/space/outputlogs112/blacklist{0}.csv'.format(hold), method='binHist', thresbin=hold, pthreshold=thres)
	'''
