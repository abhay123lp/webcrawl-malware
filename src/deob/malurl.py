from datetime import datetime
import commands
import locale
import time
import sys
import re
import os

def downloadURL():
	'''
	cp data from urlcrawl machine and unzip those files.
	'''
	cmdrsync = 'rsync -avz urlcrawl:/space/malicious-urls/ /home/intern/chromium/webcrawl-malware/src/data/MALURLs/'
	cmdunzip = 'gunzip -k -f --suffix .gzip /home/intern/chromium/webcrawl-malware/src/data/MALURLs/*.gzip'
	print cmdrsync + '\n' + cmdunzip
	print commands.getoutput(cmdrsync + '; ' + cmdunzip)


def formatToURL(infile, outfile):
	print infile
	print outfile
	inf = open(infile, 'r')
	outf = open(outfile, 'w')
	for line in inf:
		line = line.split(',')
		if len(line) != 6:
			continue
		url = line[0]
		tag = line[4]
		outf.write(url + ',' + tag +'\n')


def malurl():
	locale.setlocale( locale.LC_ALL, 'en_US.UTF-8' )

	downloadURL()

	basedir = '../data/URLs/'
	cmdlsinput = 'ls ../data/MALURLs/www.malwareurl.com-*'
	inputfiles = commands.getoutput(cmdlsinput).split('\n')

	for inputfile in inputfiles:
		try:
			date = inputfile.split('-')[1:]
			date = datetime(int(date[0]), int(date[1]), int(date[2]))
		except:
			print 'Error: bad filename', inputfile
			continue
		outputfile = basedir + 'malurl-' + date.strftime('%Y-%m-%d')
		if not os.path.exists(outputfile):
			print date
			formatToURL(inputfile, outputfile)


def main():
	malurl()


if __name__=="__main__":
	main()
