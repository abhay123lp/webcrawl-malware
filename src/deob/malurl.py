from datetime import datetime
import commands
import hashlib
import locale
import gzip
import time
import sys
import re
import os

def downloadURL():
	'''
	cp data from urlcrawl machine and unzip those files.
	'''
	cmdrsync = 'rsync -avz urlcrawl:/space/malicious-urls/ /home/intern/chromium/webcrawl-malware/src/data/MALURLs/'
	# cmdcp = 'cp /space/malicious-urls/ ../../data/TempData/MALURLs/'
	cmdunzip = 'gunzip -k -f --suffix .gzip ../../data/TempData/MALURLs/*.gzip'
	# print cmdrsync + '\n' + cmdunzip
	print cmdrsync + '\n' + cmdunzip
	print commands.getoutput(cmdrsync + '; ' + cmdunzip)


def cpURL():
	cmdcp = 'cp /space/malicious-urls/ ../../data/TempData/MALURLs/'


def formatToURL(infile, outfile):
	print infile
	print outfile
	inf = gzip.open(infile, 'rb')
	inf = inf.read().split('\n')
	outf = open(outfile, 'w')
	for line in inf:
		line = line.split(',')
		if len(line) != 6:
			continue
		url = line[0]
		tag = line[4]
		hexhash = hashlib.sha256(url).hexdigest()
		outf.write(hexhash + ',' + url + ',' + tag + '\n')


def malurl():
	locale.setlocale( locale.LC_ALL, 'en_US.UTF-8' )

	# downloadURL()
	cpURL()

	basedir = '../../data/TempData/URLs/'
	cmdlsinput = 'ls ../../data/TempData/MALURLs/www.malwareurl.com-*'
	inputfiles = commands.getoutput(cmdlsinput).split('\n')

	for inputfile in inputfiles:
		try:
			date = inputfile.split('-')[1:]
			date[2] = date[2].split('.')[0]		# get rid of the .gzip suffix
			date = datetime(int(date[0]), int(date[1]), int(date[2]))
		except:
			print 'Error: bad filename', inputfile
			continue
		outputfile = basedir + 'malurl-' + date.strftime('%Y-%m-%d')
		if not os.path.exists(outputfile):
			print date
			formatToURL(inputfile, outputfile)


def main():
	while True:
		malurl()
		time.sleep(60 * 60 * 24)


if __name__=="__main__":
	main()
