from psqloperation import PsqlCon
import chromeDeob
import jsbeautify
import rmcomment
import chunkJS
import malurl
import utils


def deobLink(url, jscommentname, jsname, chunkoutdir, beautifydir):
	chromeDeob.chromeDeobLink(url, jscommentname)
	# rmcomment.rmCommentFile(jscommentname, jsname)
	chunkJS.chunkJSFile(jscommentname, chunkoutdir)
	jsbeautify.jsdeobfuscatedir(chunkoutdir, beautifydir)


def deobFile(filename):
	log = utils.LOG()
	progress = log.STATUS(filename)
	thefile = open(filename, 'r')
	count = 0
	for line in thefile:
		count = count + 1
		if count < progress:
			continue
		else:
			log.UPDATE(filename, count)
		print line
		paras = utils.genTempnameLine(line)
		deobLink(paras[0], paras[1], paras[2], paras[3], paras[4])
		log.UPDATE(filename, count)


def deobLabel(label):
	con = PsqlCon()
	res = con.psqlSelectOneLabel('TEST')
	for url, url_hash, label in res:
		paras = utils.genTempnameTuple(url, url_hash, label)
		deobLink(paras[0], paras[1], paras[2], paras[3], paras[4])


def deobTerry():
	malurl.formatFile('../../data/JSTerry/javascript_20131018/terryurl', '../../data/TempData/URLs/terryurl')
	deobFile('../../data/TempData/URLs/terryurl')
	# jsbeautify.deobJSTerry()


if __name__=='__main__':
	'''
	con = PsqlCon()
	print con.psqlSelectOneLabel('TEST')
	# deobLabel('TEST')
	
	# Store the related information into 
	con.psqlReadURLHashFromFile('../../data/TempData/URLs/terryurl')
	'''


	# deobfuscate one file and generate output to ../../data/JSAdd2Tree
	deobFile('../../data/TempData/URLs/malurl-2013-05-20')
	


	'''
	For examples from Terry, 21 of them cannot be compiled. 26 of them are deobfuscated through modified chrome, 8 of them are deobfuscated through modified v8.
	There are 34 valid examples out of 56 examples.
	Out of the 21 script that cannot be compiled, 3 of them are just beautified. The rest are not used.
	'''
	# deobfuscate examples from terry and generate output to ../../data/JSAdd2Tree
	# Using modified chrome
	# deobTerry()
	
	# Using modified v8
	# utils.D8Terry()
