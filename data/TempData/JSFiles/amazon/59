if(!window.$SearchJS&&window.$Nav)window.$SearchJS=$Nav.make("sx");
window.$SearchJS&&$SearchJS.when("jQuery","search-js-autocomplete").run("sabc-lib",function(e,h){if(!window.amzn)window.amzn={};if(!amzn.sx)amzn.sx={};if(!amzn.sx.sabc)amzn.sx.sabc={};if(!amzn.sx.utils)amzn.sx.utils={};var m=amzn.sx.sabc,k=amzn.sx.utils;k.indexOf=k.indexOf||function(e,h){for(var i=0;i<e.length;i++)if(e[i]===h)return i;return-1};k.getLoggers=k.getLoggers||function(h){var n=["debug","error","warn","info"],i=location.href.match("[?#&]"+h+"=("+n.join("|")+")"),i=i?i[1]:void 0,i=k.indexOf(n,
i),o={};e.each(n,function(e,f){o[f]=i>=0&&i<=e?function(e){if(console&&console[f])console[f](e);else console&&console.log&&console.log(f+" : "+e)}:function(){}});return o};m.Controller=function(m,n,i,o,I,f){function J(){for(var a=[B],b;b=a[0].parent();)if(a.unshift(b),b[0].tagName.toLowerCase()=="body")break;for(;a.length!=1;)b=a.shift(),b.children().each(function(b,d){d=e(d);d[0]!=a[0][0]&&d.hide()})}function l(a){return a&&k.indexOf(I,a)==-1}function u(){var a=h.encoding();return a?a[0]+"="+encodeURIComponent(a[1])+
"&":""}function C(a,b){var c=e("#issprefix");if(c.length&&(c=c.attr("value")))return encodeURIComponent(c).replace(/(%20|\s)/g,"+");if(a&&b)return encodeURIComponent(a+","+b).replace(/(%20|\s)/g,"+")}function D(a,b,c,d,e,g){var e=e?"true":"false",f=escape("i:"+c)+escape(",k:")+encodeURIComponent(d),b=C(b,c);return"#"+a+"?"+u()+"url="+escape("search-alias="+c)+"&field-keywords="+encodeURIComponent(d)+(b?"&sprefix="+b:"")+"&rh="+f+"&sepatfbtf="+e+"&tc="+g}function v(a,b,c,d){b=C(b,c);return"/s"+a+"?"+
u()+"url="+escape("search-alias="+c)+"&field-keywords="+encodeURIComponent(d)+(b?"&sprefix="+b:"")}function p(a){for(j[q]={eventName:q};w.length;){var b=w.pop(),c=b[0],b=b[1];c.readyState!=4&&(g.debug("aborting ajax request for the "+b+" event"),c.abort())}location.href=a}function x(){if(j[q])return g.debug("event received after transition already effected - no action"),!1;var a=j[y];if(!a)return g.debug("event received before search committed - no action"),!1;var b=a.refTag,c=a.alias,d=a.keywords,
a=a.clickTime,e=j["emptyPage_"+c],f=j["predictiveATF_"+c+"_"+encodeURIComponent(d)],h=f&&f.prefix;if(!e||e.status===r||f&&f.status===r)return g.debug("ajax failed - revert to normal search"),p(v(b,h,c,d)),!1;if(e.status===s||f&&f.status===s)return!i&&e.status===s&&!f?(g.debug("abandoning emptyPage loading - transitioning to normal search"),p(v(b,h,c,d)),!1):(g.debug("ajax still in-flight - no action"),!0);if(f&&f.status===E)return g.debug("predictive hit - transitioning to cached atf search"),p(e.url+
D(b,h,c,d,!0,a)),!1;i?(g.debug("prediction not run or missed - transitioning to cached empty search"),p(e.url+D(b,h,c,d,!1,a))):(g.debug("prediction not run or missed - transitioning to normal search"),p(v(b,h,c,d)));return!1}function z(a){(a.status==r?g.error:g.debug)(a.eventName+" is now "+(typeof JSON!="undefined"?JSON.stringify(a):a))}function F(a,b,c){if(j[q])g.debug("transition already effected - no action");else if(m==0)g.debug("ajax for "+d+" will not be run because prefetch allowance is used up");
else{var d=a.eventName;a.url=b;g.debug("ajaxing in "+d+" for "+b);var f=e.ajax({url:a.url,dataType:"text",cache:!0,timeout:8E3,type:"get",success:function(d,e){a.status=E;z(a);x();c&&c(a,b,d,e)},error:function(){a.status=r;z(a);x()}});w.push([f,d]);a.status=s;z(a);m--}}function K(a){a=a?a.match(L):null;if(!a)return[];var b=[];e.each(a,function(){var a=this.match(M);a&&a.length==2&&e.inArray(a[1],b)==-1&&b.push(a[1])});return b}function N(a,b,c){if(!j[q]&&(a=K(c))&&a.length)if(e.browser.msie){var d=
"";e.each(a,function(a,b){d+='<img src="'+b+'"/>';g.debug("image precache - "+b)});e('<div id="sabcPrecachedImages">'+d+"</div>").appendTo(e(window.document.body)).hide()}else e.each(a,function(a,b){(new Image).src=b;g.debug("image precache - "+b)})}function t(a){var b="emptyPage_"+a;j[b]?g.debug("loadEmptyPage already called for the "+a+" alias"):(j[b]={eventName:b},F(j[b],"/s/ref=nb_sb_sabc?"+u()+"url="+escape("search-alias="+a)+"&pageMinusResults=1&suo="+ +new Date),g.debug("loadEmptyPage for "+
a+" alias now running aynchronously - watch for the "+b+" event to be updated"))}function G(a,b,c){var d="predictiveATF_"+b+"_"+encodeURIComponent(c);j[d]?g.debug("loadPredictiveAtf already called for the "+b+" alias and "+c+" keywords"):(j[d]={eventName:d,prefix:a},a="/mn/search/ajax?rh="+(escape("i:"+b)+escape(",k:")+encodeURIComponent(c))+"&fromHash=undefined&section=ATF&fromApp=undefined&fromPage=page-minus-results&version=2&ajp=iss",e.browser.msie&&(a+="&asScript=1&reqKey="+encodeURIComponent("*1*"+
escape("i:"+b)+escape(",k:")+encodeURIComponent(c).replace(/(%20|\s)/g,"+")+"*null*undefined*0pred")+"&try=0"),F(j[d],a,N),g.debug("loadPredictiveATF for "+b+" alias and "+c+" keywords now running aynchronously - watch for the "+d+" event to be updated"))}function O(){A.focus(function(){var a=h.searchAlias();l(a)&&t(a)})}var f=f||[],g=k.getLoggers("sabcLogging"),B=e("#navbar"),A=e("#twotabsearchtextbox"),P=/(\/s)?(\/ref=nb_sb_.*)/i,L=/<img [^>]*[\/]?>/gi,M=/src=\\\"([\S]*?)\\\"/i,j={},s="loading",
E="done",r="failed",y="committed",q="transitioned",w=[],H;(function(){if(f&&f.length){var a,b,c,d;for(a=0;a<f.length;a++){c=f[a];d=c.match(/\uff3cu([0-9a-fA-F]{4})/g);for(b=0;b<(d?d.length:0);b++)c=c.replace(d[b],String.fromCharCode(parseInt(d[b].substr(2),16)));f[a]=c}}})();n&&O();(function(){A.keydown(function(){var a=h.searchAlias();l(a)&&t(a)})})();(function(){f&&f.length&&A.keypress(function(a){a=(a.currentTarget?a.currentTarget:a.srcElement).value+String.fromCharCode(a.keyCode);if(!(a.length<
o)){for(var b=void 0,c=0;c<f.length;c++)if(f[c].indexOf(a)==0){b=f[c];break}b&&(c=h.searchAlias(),l(c)&&G(a,c,b))}})})();(function(){e("#searchDropdownBox").change(function(){var a=h.searchAlias();l(a)&&t(a)})})();(function(){h.submit(function(){g.debug("iss submit event received");var a;a=(a=e(this).attr("action"))?a.match(P)[2]:"/ref=nb_sb_noss";var b=h.searchAlias(),c=h.keyword();if(!l(b))return g.debug("the "+b+" is not supported in Illuminati yet"),!0;if(!c)return g.debug("no sabc for keywordless searches"),
!0;j[y]={eventName:y,refTag:a,alias:b,keywords:c,clickTime:+new Date};x()&&(J(),H||(B.append("<div class='loadingSpinner'>&nbsp;</div>"),H=!0));return!1})})();(function(){h.suggest(function(a,b){if(b&&b.length&&!(a.length<o)){var c=b[0],d=c.alias||h.searchAlias(),c=c.keyword;l(d)&&(t(d),G(a,d,c))}})})()};$SearchJS.publish("search-sabc",m)});
