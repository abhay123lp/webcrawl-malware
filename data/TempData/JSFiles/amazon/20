(function () {
    var referSite = document.referrer.split('?');
    var siteName = "amazon.com";
    var serverName = "www.amazon.com";
    var zcnName = "z.cn";
    var amznCNName = "amazon.cn";
    var amznUSName = "amazon.com";
    if (referSite[0].indexOf(siteName) != -1 || referSite[0].indexOf(zcnName) != -1
        || referSite[0].indexOf(serverName) != -1 || referSite[0].indexOf(amznCNName) != -1 || referSite[0].indexOf(amznUSName) != -1){
        return;
    }
    var URL = window.location.toString();
    var urlPattern = /^https/;
    if (urlPattern.test(URL)) {
        return;
    }
    var useAUI = (typeof window.P === "object" && typeof window.P.when === "function");
    function jQueryCallback($) {
        if (!$) {
            return;
        };
        var isIE6 = false;
        var isIE7 = false;
        if ($.browser.msie) {
            isIE6 = (parseInt($.browser.version, 10) < 7) ? 1 : 0;
            isIE7 = (parseInt($.browser.version, 10) == 7) ? 1 : 0;
        }
        if (isIE6 && ""){
            return;
        }
        var tooltipSize = isIE6 ? 200 : 250;
        var popoverContainer;
        var signInPopover;
        var tooltipTimer;
        var signInPopoverOptions = {
            'align': "center",
            'closeEventInclude': "CLICK_OUTSIDE",
            'forceAlignment': true,
            'focusOnShow': false,
            'location': 'bottom',
            'localContent': "#sign-in-tooltip-anchor-point",
            'locationElement': "#nav-your-account",
            'locationMargin': 8,
            'paddingBottom': 0,
            'paddingLeft': 20,
            'paddingRight': 20,
            'showCloseButton': true,
            'showOnHover': false,
            'onHide': function () { signInPopover = undefined; },
            'onShow' : function () {
                if($.browser.msie)
                    $("#sign-in-tooltip-body").show();
                else
                    $("#sign-in-tooltip-body").fadeIn(1000);
                tooltipTimer = constructTooltipTimer();
            },
            'skin': isIE6 ?
                     "<div style='border:1px solid #aed2ee;background-color:white; padding:8; text-align:right;'>" +
                         "<a id='sign-in-tooltip-ie6-cross' href='#' rel='tooltip-cross'> <span style = 'font-weight:bold'>X</span></a>" +
                         "<div class='ap_content' style='padding:20px 20px 8px 20px;'></div>" +
                     "</div>" : 'default',
            'width': tooltipSize,
            'zIndex': 999
        };
        var dismissPopover = function (popover) {
            if (popover) {
                popover.close();
            }
        };
        var repositionPopover = function (popover) {
            if (popover) {
                popover.reposition();
            }
        }
        var zoomIE7 = function () {
            if (isIE7){
	            var ie7Window = document.body.getBoundingClientRect();
	            var zoomLevel = (ie7Window.right - ie7Window.left)/document.body.clientWidth;
	            if (zoomLevel == 1){
	            	return false;
	            } else {
	                return true;
	            }
            } else {
                return false;
            }
        }
        var constructTooltip = function () {
            if(! $.browser.msie) {
                $.get("http://fls-na.amazon.com/1/action-impressions/1/OE/cust-rec/action/sign_in_tooltip_:1?marketplaceId=ATVPDKIKX0DER&session=000-0000000-0000000&requestId=08VT9Q67DMQP7DQEVJZ7");
            }
            var css = {};
            if (isIE6) {
                css.top = "-16px";
                css.left = "92px";
            } else {
                css.left = "92px";
            }
            $('.sign-in-tooltip-beak').css(css);
            var hasFocus = ($(document.activeElement)[0].id == 'twotabsearchtextbox') ? 1:0;
            signInPopover = $.AmazonPopover.displayPopover(signInPopoverOptions);
            $('a[id="sign-in-tooltip-ie6-cross"]').click( function() {
                dismissPopover(signInPopover);
            });
            var scrollTop = $(document).scrollTop();
            if (hasFocus & scrollTop < 100) {
                $('#twotabsearchtextbox').focus();
            }
            popoverContainer = $("#sign-in-tooltip-anchor-point").parents(".ap_popover");
            if (popoverContainer) {
                popoverContainer.hover(
                    function () {
                        clearTimeout(tooltipTimer);
                    },
                    function () {
                        tooltipTimer = constructTooltipTimer();
                    }
                );
            }
            $(window).resize(function (eventObject) {
                if (zoomIE7()){
                    dismissPopover(signInPopover);
                }
                repositionPopover(signInPopover);
            });
        };
        var constructTooltipTimer = function () {
            return setTimeout(function () {
                if (signInPopover) {
                    if (popoverContainer && !($.browser.msie && parseInt($.browser.version, 10) < 9)) {
                        popoverContainer.fadeOut(1000, function () {
                            dismissPopover(signInPopover);
                        });
                    } else {
                        dismissPopover(signInPopover);
                    }
                }
            }, 10000);
        };
        var popoverCallbackAUI = function(){
        }
        var popoverCallback = function () {
            var dismissed = false;
            var navDismissCallback = function () {
                dismissed = true;
                dismissPopover(signInPopover);
            };
            if (useAUI) {
            P.when('navDismissTooltip').execute(navDismissCallback);
            } else {
            amznJQ.available('navDismissTooltip', navDismissCallback);
            }
            var horizontalSprite = new Image();
            var verticalSprite = new Image();
            var beakSprite = new Image();
            if (0){
                if (!dismissed && !zoomIE7()) {
                    constructTooltip();
                }
            } else {
                horizontalSprite.onload = function () {
                    if (!dismissed && !zoomIE7()) {
                        constructTooltip();
                    }
                }
            }
            horizontalSprite.src = "http://g-ecx.images-amazon.com/images/G/01/javascripts/lib/popover/images/light/sprite-h._V219326280_.png";
            verticalSprite.src = "http://g-ecx.images-amazon.com/images/G/01/javascripts/lib/popover/images/light/sprite-v._V219326283_.png";
            beakSprite.src = "http://g-ecx.images-amazon.com/images/G/01/javascripts/lib/popover/images/light/sprite-vertical-popover-arrow2._V371798167_.gif";
        };
        setTimeout(function(){
            if ($.AmazonPopover && $.AmazonPopover.displayPopover) {
                popoverCallback();
            }
            else{
                popoverCallbackAUI();
            }
        },500);
    };
    if (useAUI) {
        window.P.when('jQuery', 'ready', 'legacy-popover').execute(jQueryCallback);
    } else if (window.amznJQ) {
        window.amznJQ.available('jQuery', function() {
            window.amznJQ.available('popover', function() {
                window.amznJQ.jQuery(document).ready(function (){
                    jQueryCallback(window.amznJQ.jQuery);
                });
            });
        });
    }
})();
